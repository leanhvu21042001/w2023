<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 7: Data security | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.494dd125.css" as="style"><link rel="preload" href="/w2023/assets/js/app.60650c02.js" as="script"><link rel="preload" href="/w2023/assets/js/3.4b0adc00.js" as="script"><link rel="preload" href="/w2023/assets/js/12.9a8f0e36.js" as="script"><link rel="preload" href="/w2023/assets/js/15.c072e039.js" as="script"><link rel="preload" href="/w2023/assets/js/16.98a772dc.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.f600ef9c.js"><link rel="prefetch" href="/w2023/assets/js/11.59cce816.js"><link rel="prefetch" href="/w2023/assets/js/13.b4c9d204.js"><link rel="prefetch" href="/w2023/assets/js/14.1bbcf46f.js"><link rel="prefetch" href="/w2023/assets/js/17.2696ccfd.js"><link rel="prefetch" href="/w2023/assets/js/18.4c772c8d.js"><link rel="prefetch" href="/w2023/assets/js/19.0ed82ce5.js"><link rel="prefetch" href="/w2023/assets/js/2.5288beb2.js"><link rel="prefetch" href="/w2023/assets/js/20.770d7140.js"><link rel="prefetch" href="/w2023/assets/js/21.6ef972b3.js"><link rel="prefetch" href="/w2023/assets/js/22.ef81ef04.js"><link rel="prefetch" href="/w2023/assets/js/23.417c179f.js"><link rel="prefetch" href="/w2023/assets/js/24.bdbbc474.js"><link rel="prefetch" href="/w2023/assets/js/25.036dac97.js"><link rel="prefetch" href="/w2023/assets/js/26.cfed9991.js"><link rel="prefetch" href="/w2023/assets/js/27.f330a31c.js"><link rel="prefetch" href="/w2023/assets/js/28.49afbf1d.js"><link rel="prefetch" href="/w2023/assets/js/29.37e36a86.js"><link rel="prefetch" href="/w2023/assets/js/30.32dcbee6.js"><link rel="prefetch" href="/w2023/assets/js/31.0af45ea5.js"><link rel="prefetch" href="/w2023/assets/js/32.7ce3bc44.js"><link rel="prefetch" href="/w2023/assets/js/33.589d5da0.js"><link rel="prefetch" href="/w2023/assets/js/34.fd5d60cc.js"><link rel="prefetch" href="/w2023/assets/js/35.eb1cbce0.js"><link rel="prefetch" href="/w2023/assets/js/36.2c862154.js"><link rel="prefetch" href="/w2023/assets/js/37.5398f93e.js"><link rel="prefetch" href="/w2023/assets/js/38.cf75b57c.js"><link rel="prefetch" href="/w2023/assets/js/39.9092bb5a.js"><link rel="prefetch" href="/w2023/assets/js/4.a4d15534.js"><link rel="prefetch" href="/w2023/assets/js/5.9ee2e4c7.js"><link rel="prefetch" href="/w2023/assets/js/6.62eb8be9.js"><link rel="prefetch" href="/w2023/assets/js/7.109c5752.js"><link rel="prefetch" href="/w2023/assets/js/8.8ff7fd07.js"><link rel="prefetch" href="/w2023/assets/js/9.42e2f10f.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.494dd125.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2023/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2023/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2023/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/w2023/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/w2023/modules/week5/" class="sidebar-link">Week 5: Data persistance</a></li><li><a href="/w2023/modules/week6/" class="sidebar-link">Week 6: Object Data Modeling</a></li><li><a href="/w2023/modules/week7/" aria-current="page" class="active sidebar-link">Week 7: Data security</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#better-debugging" class="sidebar-link">Better Debugging</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#environment-variables" class="sidebar-link">Environment Variables</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#npm-scripts" class="sidebar-link">NPM Scripts</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#sanitization" class="sidebar-link">Sanitization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#xss-protection" class="sidebar-link">XSS Protection</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#recursion" class="sidebar-link">Recursion</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#database-injection" class="sidebar-link">Database Injection</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week7/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/w2023/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2023/modules/week8/" class="sidebar-link">Week 8: Access Control with JWT</a></li><li><a href="/w2023/modules/week9/" class="sidebar-link">Week 9: JWT Review</a></li><li><a href="/w2023/modules/week10/" class="sidebar-link">Week 10: Consistent Error Handling</a></li><li><a href="/w2023/modules/week11/" class="sidebar-link">Week 11: Production Preparation</a></li><li><a href="/w2023/modules/week12/" class="sidebar-link">Week 12: Testing</a></li><li><a href="/w2023/modules/week13/" class="sidebar-link">Week 13: Production Deployment</a></li><li><a href="/w2023/modules/week14/" class="sidebar-link">Week 14: Final Lab</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 7</span><br> <span class="title">Data security: validation, sanitization</span></h1> <div class="custom-block danger"><p class="custom-block-title">Quiz 6: Data models <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>Guest Speaker (50 mins)</li> <li>Break (10 mins)</li> <li>AMA (10 mins)</li> <li>Quiz (10 mins)</li> <li>Better Debugging (20 mins)</li> <li>Input Sanitization (20 mins)</li> <li>Break (10 mins)</li> <li>Data Validation (20 mins)</li> <li>Lab Time (30 mins)</li></ul> <h2 id="better-debugging"><a href="#better-debugging" class="header-anchor">#</a> Better Debugging</h2> <p>Before we dig into recommended practices for guarding against data corruption and scripting attacks through input data validation and sanitization, let's add another tool to our development toolbox.</p> <p>The <a href="https://www.npmjs.com/package/debug" target="_blank" rel="noopener noreferrer">debug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM module is a better <code>console.log</code> that you can turn on and off with an environment variable instead of commenting out the debugging statements in your code. It is used internally by all of the modules in the Express framework, and we can use it in our modules as well.</p> <p>Install debug as a project dependency.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> debug
</code></pre></div><p>Make it available in <code>app.js</code> and set the namespace to the application name.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The primary debug namespace should match the <code>name</code> property in <code>package.json</code>.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'week7'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/database'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// IIFE</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express is listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>To keep the main entry module for our project (app.js) as clean as possible. It is a good practice to move one-time setup activities, like connecting to the database, into separate modules in a <code>/startup</code> or a <code>/bootstrap</code> folder. Let's put our Mongoose connection setup code from week 6 in the <code>/startup/database.js</code> module.</p> <p>Then at the top of that file, require the debug module setting the namespace to <code>week7:db</code> and change any <code>console.log()</code> statements to <code>debug()</code> statements. The completed code should look like this.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'week7:db'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose
    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mongodb://localhost:27017/mad9124</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">useNewUrlParser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">useUnifiedTopology</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connected to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error connecting to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> Environment Variables</h3> <div class="custom-block tip"><p class="custom-block-title">Remember</p> <p>The debug module suppresses output by default.</p></div> <p>If we run the app now with <code>node app.js</code> it will not output anything to the console. We need to activate it by setting the <code>DEBUG</code> environment variable to our application namespace before running the application.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>week7 <span class="token function">node</span> app.js
</code></pre></div><p>Hmmm ... still not quite right. We only saw the debug message from app.js, not from the database connection module. Debug allows us to be very selective about which module's messages we want to see. If we run it again with ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>week7:db <span class="token function">node</span> app.js
</code></pre></div><p>... now we only see the database connection message.</p> <p>To see all related namespaces we can use the <code>*</code> wildcard character.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>week7* <span class="token function">node</span> app.js
</code></pre></div><h3 id="npm-scripts"><a href="#npm-scripts" class="header-anchor">#</a> NPM Scripts</h3> <p>Our application startup command is starting to get long. What if we want to add some other environment variables like <code>NODE_ENV</code> or <code>PORT</code>?</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span>week7* <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>dev <span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token function">node</span> app.js
</code></pre></div><p>NPM has a solution to make this easier. In the <code>package.json</code> file there is a <code>scripts</code> option. We can set different startup instructions for different environments. By default, it looks like this.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Let's add a <code>start</code> script for production and a <code>dev</code> script to use with our local development.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=production PORT=433 node app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;DEBUG=week7* NODE_ENV=dev PORT=3000 nodemon app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Now we can start our development server by running ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> run dev
</code></pre></div><p>Or we can start up in production mode with <code>npm start</code>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>We have more configuration work to do before we are ready for production mode. We will cover that in a few weeks.</p></div> <h2 id="sanitization"><a href="#sanitization" class="header-anchor">#</a> Sanitization</h2> <p>The very nature of our application is to take user input and act on it in some way, either to store information or searching and filtering information from the database. The data stored is ultimately returned to the client application.</p> <p>This means that our web service application is inherently vulnerable to a variety of malicious attacks. <strong>We cannot trust any data coming from the client application.</strong> It might not be our code. It may have been hacked. A malicious actor may be using it to directly input data formatted to cause our system to malfunction.</p> <p><a href="https://www.owasp.org" target="_blank" rel="noopener noreferrer">The Open Web Application Security Project (OWASP)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is an excellent resource for staying up to date on application security risks and best practices. Among their many resources, the annual <a href="https://www.owasp.org/images/7/72/OWASP_Top_10-2017_%28en%29.pdf.pdf" target="_blank" rel="noopener noreferrer">OWASP Top 10 Critical Web Application Security Risks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> should be on your reading list.</p> <p>Directly relevant to our task is the <a href="http://nodegoat.herokuapp.com/tutorial" target="_blank" rel="noopener noreferrer">OWASP Node Goat Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that provides examples of the Top 10 in a Node.js application environment.</p> <p>Let's look at solving the two most damaging attack types: Cross-site scripting (XSS) and Database Injection. To do that, we need to filter and cleanse all incoming data.</p> <h3 id="xss-protection"><a href="#xss-protection" class="header-anchor">#</a> XSS Protection</h3> <p>To help protect against <a href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noopener noreferrer">Cross-site scripting (XSS) attacks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> we need to strip out any HTML or script tags from the input values so that they would not be interpreted as scripts or alter the browser rendering of any returned data. We will use the <a href="https://www.npmjs.com/package/xss" target="_blank" rel="noopener noreferrer">xss<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM package.</p> <p>We will build a small middleware function to implement this behaviour. Create a new file in the <code>middleware</code> folder called <code>sanitizeBody.js</code>. Require the <code>debug</code> and <code>xss</code> modules at the top. Then add an empty middleware function signature. (We will fill in the logic in the next step.)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// sanitization logic goes here</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Remember</p> <p>It is a good practice not to take destructive action on the original request body. So, make a copy to work with and set the resulting sanitized version as a new property of the request object that downstream route handlers can access.</p></div> <p>Start by stripping out any <code>id</code>, or <code>_id</code> properties. We never want those.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
</code></pre></div><p>The <code>xss</code> module applies its filter rules to strings. To apply it to the various properties of our user supplied data, we will need to loop over the members of the <code>req.body</code> object with a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in" target="_blank" rel="noopener noreferrer">for...in<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> loop.</p> <p>The <code>xss</code> function takes an optional configuration object to customize how it works.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// empty, means filter out all tags</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// filter out all HTML not in the whitelist</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token comment">// the script tag is a special case, we need</span>
    <span class="token comment">// to filter out its content</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Lastly set the modified <code>attributes</code> as the value of a new <code>req.sanitizedBody</code> property and then call <code>next()</code>. The whole thing should look similar to this.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span>attributes<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">sanitizedBody</span><span class="token operator">:</span> attributes<span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> attributes
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Notice that I added some debug statements just to help verify that everything is working. To see these print out, add modify the <code>dev</code> script's debug environment variable in the <code>package.json</code> file to <code>DEBUG=week7*,sanitize*</code></p></div> <p>OK, we have our body sanitizer middleware function. How do we use it?</p> <p>Remember, Express route method declarations can take more than one callback function. This lets us call one or more middleware functions directly for any given route.</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> routeHandler<span class="token punctuation">)</span>
</code></pre></div><p>So, in our <code>/routes/cars.js</code> module, we could do this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sanitizeBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/sanitizeBody'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Car <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./models/Car'</span><span class="token punctuation">)</span>
<span class="token comment">// ... other setup</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newCar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">await</span> newCar<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> newCar<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">errorHandlerFunction</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>We can now be reasonably confident that only plain text strings will be passed to Mongoose for validation. Potentially malicious HTML and JavaScript will be removed from input strings.</p> <p>We can test it with Postman.</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test.72d9c06c.png" alt="screenshot of Postman test"></p> <p>Yay! It worked!</p> <p><strong>But wait.</strong> What if the payload attributes are not simple strings? We need to refactor the sanitizeBody middleware to call itself recursively for more complex data structures.</p> <h3 id="recursion"><a href="#recursion" class="header-anchor">#</a> Recursion</h3> <p>From <a href="https://javascript.info/recursion" target="_blank" rel="noopener noreferrer">The Modern JavaScript Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>When a function solves a task, in the process it can call many other functions. A partial case of this is when a function calls <em>itself</em>. That’s called recursion.</p></blockquote> <p>We will start by creating a new function called <code>stripTags</code>. It should take a single argument - let's call it payload. Now cut the <code>for...in</code> loop from the main function and paste it into the new one. As a best practice, we should not mutate the original payload object that is passed in, so let's make a copy of that with the line <code>let attributes = {...payload}</code>. Don't forget to return the sanitized <code>attributes</code> at the end of this new function.</p> <p>Then call the new <code>stripTags</code> function from within the primary function. The refactored middleware should now look like this.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">stripTags</span> <span class="token operator">=</span> <span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>payload<span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> attributes
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span>attributes<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> sanitizedBody <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">sanitizedBody</span><span class="token operator">:</span> sanitizedBody<span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> sanitizedBody
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This version should be functionally equivalent to what we had before. Test it with Postman to be sure that it is working.</p> <p>OK now we can augment the <code>stripTags</code> function to check for objects and then call itself to loop over that nested object and sanitize it's properties. Wrap the logic inside the <code>for..in</code> loop in an <code>if/else</code> block.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test that with Postman ...</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test-object.7f133f65.png" alt="screenshot of Postman test"></p> <p>Great! Now let's make sure that we handle Arrays properly. Since arrays inherit from Object in JavaScript, we need to check for that case first. Then instead of just recursively calling <code>stripTags</code> on the array, we need to use the <code>.map()</code> method to loop over the array.</p> <p>Each element could be another complex object or a simple string. We need to check and handle both cases. If it is a string we can call <code>xss()</code> otherwise call <code>stripTags()</code> again.</p> <p>Rather than duplicate the code for the <code>xss()</code> function call, let's extract that to a separate function in our module.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">sanitize</span> <span class="token operator">=</span> <span class="token parameter">sourceString</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">xss</span><span class="token punctuation">(</span>sourceString<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then the conditional block in the <code>stripTags()</code> function becomes ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The return statement of the <code>map()</code> method above is using <a href="http://javascript.info/ifelse#ternary-operator" target="_blank" rel="noopener noreferrer">JavaScript's ternary operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, rather than a more verbose if/else block.</p> <p>Writing out that single ternary expression the long way would look something like this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> cleanedElement
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cleanedElement <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  cleanedElement <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> cleanedElement
</code></pre></div></div> <p>OK. Test that with Postman ...</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test-array.e6a684b2.png" alt="screenshot of Postman test"></p> <p>Phew!</p> <p>The final version of the <code>sanitizeBody.js</code> middleware module should look similar to this (with no debug statements).</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitize</span> <span class="token operator">=</span> <span class="token parameter">sourceString</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">xss</span><span class="token punctuation">(</span>sourceString<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">stripTags</span> <span class="token operator">=</span> <span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>payload <span class="token punctuation">}</span> <span class="token comment">// don't mutate the source data</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span>
          <span class="token operator">?</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token comment">// if true</span>
          <span class="token operator">:</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token comment">// if false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> attributes
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token keyword">const</span> sanitizedBody <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> sanitizedBody
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>OK. Now we can be reasonably sure that all HTML tags and scripts will be removed from all <code>req.body</code> properties, no matter how deeply they are buried.</p> <h3 id="database-injection"><a href="#database-injection" class="header-anchor">#</a> Database Injection</h3> <p>Using Mongoose which enforces schema validation and attempts type coercion to ensure that only data in the correct format is stored, goes a long way to protecting MongoDB from various attacks. However, there are still some cases that are not covered.</p> <p>Read <a href="https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb.html" target="_blank" rel="noopener noreferrer">Hacking Node.js and MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to learn more about this kind of vulnerability.</p> <p>To help protect against database injection attacks, we will use the <a href="https://www.npmjs.com/package/express-mongo-sanitize" target="_blank" rel="noopener noreferrer">Express Mongoose Sanitize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM package.</p> <p>From the docs ...</p> <blockquote><h4 id="what"><a href="#what" class="header-anchor">#</a> What?</h4> <p>This module searches for any keys in objects that begin with a $ sign or contain a ., from req.body, req.query or req.params. It can then either:</p> <ul><li>completely remove these keys and associated data from the object, or</li> <li>replace the prohibited characters with another allowed character.</li></ul> <p>The behaviour is governed by the passed option, replaceWith. Set this option to have the sanitizer replace the prohibited characters with the character passed in.</p> <h4 id="why"><a href="#why" class="header-anchor">#</a> Why?</h4> <p>Object keys starting with a $ or containing a . are reserved for use by MongoDB as operators. Without this sanitization, malicious users could send an object containing a $ operator, or including a ., which could change the context of a database operation. Most notorious is the $where operator, which can execute arbitrary JavaScript on the database.</p> <p>The best way to prevent this is to sanitize the received data, and remove any offending keys, or replace the characters with a 'safe' one.</p></blockquote> <h4 id="let-s-install-it"><a href="#let-s-install-it" class="header-anchor">#</a> Let's install it</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> express-mongo-sanitize
</code></pre></div><h4 id="let-s-implement-it"><a href="#let-s-implement-it" class="header-anchor">#</a> Let's implement it</h4> <p>We could implement this middleware on a route by route basis. e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Or at the router level ...</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> carsRouter<span class="token punctuation">)</span>
</code></pre></div><p>Or at the application level ...</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's choose the application level -- <em>set it and forget it!</em></p> <div class="custom-block tip"><p class="custom-block-title">Don't forget</p> <p>You need to require the module before you can use it.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sanitizeMongo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-mongo-sanitize'</span><span class="token punctuation">)</span>
</code></pre></div></div> <h2 id="for-next-week"><a href="#for-next-week" class="header-anchor">#</a> For next week</h2> <p>Before next week's class, please read these additional online resources.</p> <ul><li><a href="https://codeburst.io/learn-and-understand-recursion-in-javascript-b588218e87ea" target="_blank" rel="noopener noreferrer">Learn and Understand Recursion in JavaScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.html5rocks.com/en/tutorials/security/content-security-policy/" target="_blank" rel="noopener noreferrer">An Introduction to Content Security Policy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb.html" target="_blank" rel="noopener noreferrer">Hacking Node.js and MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://nodegoat.herokuapp.com/tutorial" target="_blank" rel="noopener noreferrer">OWASP Node Goat Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">Assignment Reminder</p> <p><a href="/w2023/deliverables/assignment2.html">Assignment 2 - Mongo CRUD</a> - is due <strong>before</strong> 1:00 pm on Friday, March 6th.</p></div> <div class="custom-block warning"><p class="custom-block-title">Quiz</p> <p>There will be a short quiz next class. The questions could come from any of the material referenced above.</p></div> <div class="custom-block tip"><p class="custom-block-title">Next week is Break Week</p> <p>This is a great opportunity to review the course notes and the linked hybrid study materials from what we have covered so far.</p> <p>As a self-assessment tool to help you identify areas that might need more review, I have posted an optional <strong>ungraded review quiz</strong> covering the first half of the term.</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/4/2020, 2:40:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/week6/" class="prev">
        Week 6: Object Data Modeling
      </a></span> <span class="next"><a href="/w2023/modules/break-week/">
        Break Week
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.60650c02.js" defer></script><script src="/w2023/assets/js/3.4b0adc00.js" defer></script><script src="/w2023/assets/js/12.9a8f0e36.js" defer></script><script src="/w2023/assets/js/15.c072e039.js" defer></script><script src="/w2023/assets/js/16.98a772dc.js" defer></script>
  </body>
</html>
